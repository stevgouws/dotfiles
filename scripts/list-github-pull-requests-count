#!/usr/bin/env bash
set -euo pipefail

# --- Config ---
owner="VoxSmartLtd"
repos=( "vs-fe-unified-ui-svc" "vs-fe-vx1-components-lib" )

# --- Date window (default: last 90 days, UTC) ---
# Works on both GNU date (Linux) and BSD date (macOS).
if date -u -d '1 day ago' +%F >/dev/null 2>&1; then
  SINCE="${SINCE:-$(date -u -d '90 days ago' +%F)}"
else
  SINCE="${SINCE:-$(date -u -v -90d +%F)}"
fi
UNTIL="${UNTIL:-$(date -u +%F)}"

tmp="$(mktemp)"
: > "$tmp"

echo "Collecting reviews from $SINCE to $UNTIL..."

for repo in "${repos[@]}"; do
  echo "-> ${owner}/${repo}"
  prs=$(gh search prs \
    --repo "$owner/$repo" \
    --created "${SINCE}..${UNTIL}" \
    -L 200 \
    --json number --jq '.[].number') || true

  if [[ -z "$prs" ]]; then
    echo "  (no PRs found in this window)"
    continue
  fi

  while read -r pr; do
    gh api "/repos/$owner/$repo/pulls/$pr/reviews?per_page=100" --paginate \
      --jq '.[] | select(.user.login != null) | {login: .user.login, submittedAt: .submitted_at}' >> "$tmp" || true
  done <<<"$prs"
done

if [[ ! -s "$tmp" ]]; then
  echo "| Reviewer | Reviews |"
  echo "|---|---:|"
  echo "| _No reviews found in this period_ | 0 |"
  exit 0
fi

jq -s '
  map(select(.login != null))
  | group_by(.login)
  | map({reviewer: .[0].login, reviews: length})
  | sort_by(-.reviews)
' "$tmp" > reviews.json

echo "| Reviewer | Reviews |"
echo "|---|---:|"
jq -r '.[] | "| \(.reviewer) | \(.reviews) |"' reviews.json | tee reviews.md >/dev/null
